var RecipeTE,__extends=this&&this.__extends||function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){function n(){this.constructor=e}if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();LIBRARY({name:"RecipeTileEntity",version:30,api:"CoreEngine",shared:!0}),function(t){t.AIR_ITEM={id:0,count:0}}(RecipeTE||(RecipeTE={})),function(t){function e(t,e,i){for(var n=0;n<e.countSlot;n++){var r=i.getInputSlots();Array.isArray(r)?r=r[n]:r+=n;var o=t.getSlot(r);o.count>0&&(o.count--,0==o.count&&(o.data=o.id=o.count)),t.setSlot(r,o.id,o.count,o.data,o.extra)}}t.defaultCraftFunction=e}(RecipeTE||(RecipeTE={})),function(t){var e=function(){function e(t,e){void 0===e&&(e=null),this.rows=1,this.countSlot=1,this._recipes=[],"number"==typeof t?this.countSlot=this.cols=t:(this.cols=t.columns,t.rows&&(this.rows=t.rows),this.countSlot=this.cols*this.rows),this.defaultRecipeData=e}return e.prototype.getDataForRecipe=function(t){var e=JSON.parse(JSON.stringify(this.defaultRecipeData));if(t&&"object"==typeof e)for(var i in t)e[i]=t[i];return e},e.prototype.getObjRecipe=function(e,i,n,r){void 0===r&&(r=t.defaultCraftFunction),void 0===e.count&&(e.count=1),void 0===e.data&&(e.data=0);var o=0,a={};if(i.forEach(function(t){void 0===t.count&&(t.count=1),void 0===t.data&&(t.data=-1),o+=t.count,a[t.id+":"+t.data]=t}),o>this.countSlot)throw new RangeError("Ingredients must be <= "+this.countSlot+"(columns * rows)");return{result:e,ingredients:a,craft:r,mask:null,data:this.getDataForRecipe(n)}},e.prototype.getObjShapeRecipe=function(e,i,n,r,o){void 0===o&&(o=t.defaultCraftFunction),void 0===e.count&&(e.count=1),void 0===e.data&&(e.data=0);var a=i.length;if(n["#"])throw new SyntaxError("Ingredient cannot be registered to char #");if(n[" "])throw new SyntaxError('Ingredient cannot be registered to chas "space"');if(n["#"]=t.AIR_ITEM,Array.isArray(i)){if(a>this.rows)throw new RangeError("Length of the mask must be <= "+this.rows);if(a<1)throw new RangeError("Length of the mask must be >= 1");var s=i[0].length;if(s>this.cols)throw new RangeError("Length of the mask line must be <= "+this.cols);if(s<1)throw new RangeError("Length of the mask line must be >= 1");for(var c=a-1;c>=0;c--){var u=i[c].length;if(0==u)i[c]="".padStart(s,"#");else{if(u!=s)throw new RangeError("Mask lines must be the same size.");i[c]=i[c].replace(/\s/g,"#")}for(var l=s-1;l>=0;l--)if(null==n[i[c][l]])throw new SyntaxError("Unknown ingredient "+i[c][l])}}else{if(a>this.countSlot)throw new RangeError("Length of the mask must be <= "+this.countSlot);if(a<1)throw new RangeError("Length of the mask must be >= 1");i=i.replace(/\s/g,"#");for(c=a-1;c>=0;c--)if(null==n[i[c]])throw new SyntaxError("Unknown ingredient "+i[c])}return{result:e,mask:i,ingredients:n,craft:o,data:this.getDataForRecipe(r)}},e.prototype.addRecipe=function(e,i,n,r){return void 0===r&&(r=t.defaultCraftFunction),this._recipes.push(this.getObjRecipe(e,i,n,r)),this},e.prototype.addShapeRecipe=function(e,i,n,r,o){return void 0===o&&(o=t.defaultCraftFunction),this._recipes.push(this.getObjShapeRecipe(e,i,n,r,o)),this},e.prototype.getRecipe=function(e){var i=this;if(e.length!=this.countSlot)throw new RangeError("Length 'inputs' != "+this.countSlot);return this._recipes.find(function(n){var r=!1;if(Array.isArray(n.mask))for(var o=i.rows-n.mask.length,a=i.cols-n.mask[0].length,s=0,c=0,u=0;u<i.rows;u++){if(u>o&&!r)return!1;for(var l=0;l<i.cols;l++){if(u>o&&!r)return!1;var h=e[u*i.cols+l];if(l>a&&!r&&h.id!=t.AIR_ITEM.id)return!1;if(r){p=t.AIR_ITEM;var d=n.mask[u-s];if(d){var f=d[l-c];f&&(p=n.ingredients[f])}if(h.id!=p.id){if(0!=n.ingredients[n.mask[0][0]].id)return!1;r=!1,u=s,l=c}}else{var p=n.ingredients[n.mask[0][0]];if(null==p.data&&(p.data=-1),p.id!=h.id||-1!=p.data&&p.data!=h.data){if(0!=h.id)return!1}else s=u,c=l,r=!0}}}else{if(!n.mask){var v={};for(y=i.countSlot-1;y>=0;y--){h=e[y];var g=h.id+":"+h.data;if(n.ingredients[h.id+":"+h.data]||(g=h.id+":-1"),n.ingredients[g])v[g]||(v[g]=0),v[g]++;else if(0!=h.id)return!1}for(var y in n.ingredients)if(n.ingredients[y].count!=v[y])return!1;return!0}for(var R=i.countSlot-n.mask.length,b=0,y=0;y<i.countSlot;y++){if(y>R&&!r)return!1;var h=e[y];if(r){p=t.AIR_ITEM,l=n.mask[y-b];if(l&&(p=n.ingredients[l]),h.id!=p.id)return!1}else{var p=n.ingredients[n.mask[0]];if(h.id==p.id)b=y,r=!0;else if(0!=h.id)return!1}}}return r},this)},e}();t.Workbench=e}(RecipeTE||(RecipeTE={})),function(t){var e=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n.timer=e.timer,n}return __extends(e,t),e}(t.Workbench);t.TimerWorkbench=e}(RecipeTE||(RecipeTE={})),function(t){var e=function(){function t(){this.list=[],this.count=0}return t.prototype.add=function(t){return this.count++,this.list.push(t)},t.prototype.remove=function(t){"number"!=typeof t&&(t=this.list.findIndex(function(e){return e==t})),delete this.list[t]},t.prototype.invoke=function(t,e,i,n,r,o,a){for(var s=Number.MAX_SAFE_INTEGER,c=0;c<this.count;c++){var u=this.list[c];if(null!=u){var l=u(t,e,i,n,r,o,a);if(0==l)return 0;l<s&&(s=l)}}return s},t}(),i=function(){function i(t,i){void 0===i&&(i=!0),this.useNetworkItemContainer=!0,this.GlobalAddPolicy=new e,this.GlobalGetPolicy=new e,this.addGlobalAddTransferPolicy=this.GlobalAddPolicy.add.bind(this.GlobalAddPolicy),this.addGlobalGetTransferPolicy=this.GlobalGetPolicy.add.bind(this.GlobalGetPolicy),this.setWorkbench(t),this.defaultValues={enabled:i}}return i.prototype.setWorkbench=function(t){this.workbench=t},i.prototype.takeResult=function(t,e,i,n,r,o,a){for(var s=0;s<n;s++)this.currentRecipe.craft(t,this.workbench,this);return n},i.prototype.setTransferPolicy=function(){this.container.setGlobalAddTransferPolicy(function(t,e,i,n,r,o,a){var s=t.getParent();if(s.getOutputSlot()==e)return 0;s.hasInputSlot(e)&&s.validRecipe(e,{id:i,data:r,count:t.getSlot(e).count+n,extra:o});var c=s.GlobalAddPolicy.invoke(t,e,i,n,r,o,a);return c<n?c:n}),this.container.setGlobalGetTransferPolicy(function(t,e,i,n,r,o,a){var s=t.getParent();if(s.getOutputSlot()==e)return s.takeResult(t,e,i,n,r,o,a);if(s.hasInputSlot(e)){var c={id:i,data:r,count:t.getSlot(e).count-n,extra:o};0==c.count&&(c={id:0,data:0,count:0}),s.validRecipe(e,c)}var u=s.GlobalGetPolicy.invoke(t,e,i,n,r,o,a);return u<n?u:n})},i.prototype.getItems=function(t,e){for(var i=[],n=this.getInputSlots(),r=0,o=this.workbench.countSlot;r<o;r++){var a=void 0;a=Array.isArray(n)?n[r]:n+r,i.push(t==a?e:this.container.getSlot(a))}return i},i.prototype.validRecipe=function(e,i){var n=this.getOutputSlot();if(!this.isEnabled())return this.currentRecipe=null,this.container.clearSlot(n);var r=this.getItems(e,i),o=this.workbench.getRecipe(r),a=t.AIR_ITEM;o&&(a=o.result),void 0===a.count&&(a.count=1),void 0===a.data&&(a.data=0);var s=1;if(0!=a.id){s=0;for(var c=r.length-1;c>=1&&1!=s;c--)(0==s&&0!=r[c].count||s>r[c].count)&&(s=r[c].count)}this.currentRecipe=o,this.container.setSlot(n,a.id,a.count*s,a.data)},i.prototype.init=function(){this.container.setParent(this),this.setTransferPolicy()},i.prototype.hasInputSlot=function(t){var e=this.getInputSlots();if(Array.isArray(e))return-1!=e.indexOf(t);var i=parseInt(t.match(new RegExp(e+"([0-9]+)"))[1]);return i>=0&&i<this.workbench.countSlot},i.prototype.setEnabled=function(t){this.data.enabled=t,this.validRecipe()},i.prototype.enable=function(){this.setEnabled(!0)},i.prototype.disable=function(){this.setEnabled(!1)},i.prototype.isEnabled=function(){return this.data.enabled},i}();t.WorkbenchTileEntity=i}(RecipeTE||(RecipeTE={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.ticks=0,e}return __extends(e,t),e.prototype.setEnabled=function(e){e||this.container.setScale(this.getScale(),this.ticks=0),t.prototype.setEnabled.call(this,e)},e.prototype.takeResult=function(t,e,i,n,r,o,a){var s={id:i,data:r,count:t.getSlot(e).count-n,extra:o};return 0==s.count&&(s={id:0,data:0,count:0}),this.validRecipe(e,s),n},e.prototype.validRecipe=function(t,e){var i=this.getItems(t,e),n=this.workbench.getRecipe(i);if(!n)return this.container.setScale(this.getScale(),this.ticks=0),this.currentRecipe=null;var r=t&&t==this.getOutputSlot()?e:this.container.getSlot(t);0==r.id||r.id==n.result.id?this.currentRecipe=n:this.currentRecipe=null},e.prototype.tick=function(){if(this.currentRecipe&&this.isEnabled()){this.ticks+=1*this.currentRecipe.data.multiply,this.container.setScale(this.getScale(),this.ticks/this.workbench.timer);var t=this.getOutputSlot();if(this.ticks>=this.workbench.timer){var e=this.container.getSlot(t);this.currentRecipe.craft(this.container,this.workbench,this),this.container.setSlot(t,this.currentRecipe.result.id,e.count+this.currentRecipe.result.count,this.currentRecipe.result.data),this.validRecipe(),this.ticks=0}}this.container.sendChanges()},e}(t.WorkbenchTileEntity);t.TimerWorkbenchTileEntity=e}(RecipeTE||(RecipeTE={})),EXPORT("RecipeTE",RecipeTE);